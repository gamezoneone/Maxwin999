<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Susun Balok Ajaib</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* ========================================= */
        /* === TEMA GLOBAL DARI PROFIL.HTML === */
        /* ========================================= */
        :root {
            --primary-neon-color: #00ffff; /* Cyan/Biru Neon */
            --secondary-neon-color: #e000ff; /* Ungu Neon */
            --success-neon-color: #39ff14; /* Hijau Neon */
            --error-neon-color: #ff4d4d; /* Merah Neon */
            --gold-neon-color: gold; /* Emas Neon */
            --dark-background-transparent: rgba(0,0,0,0.9);
            --dark-background-solid: #000000;

            /* Warna untuk Game (Diselaraskan dengan Tema Neon) */
            --game-primary-color: #FF4D4D; /* Merah untuk Peringatan/Kalah */
            --game-secondary-color: #4D4DFF; /* Biru Tua untuk Background Sekunder */
            --game-tertiary-color: var(--success-neon-color); /* Hijau Cerah untuk Kemenangan/Sukses */
            --game-accent-color: var(--primary-neon-color); /* Cyan Neon untuk Aksen & Glow */
            --game-text-light: #E0E0E0; /* Teks terang lebih soft */
            --game-text-dark: #1A1A1A; /* Teks gelap lebih solid */
            --game-canvas-bg: #0C0C0C; /* Background area permainan lebih gelap */
            --game-border-glow: var(--primary-neon-color); /* Border luar game container, senada accent */
            --game-button-bg: var(--primary-neon-color); /* Warna tombol default, senada accent */
            --game-button-active: #00B3B3; /* Warna tombol saat ditekan */
            --game-block-border: #222222; /* Warna border antar blok */
            --game-block-shadow: rgba(0, 0, 0, 0.4); /* Bayangan blok */
            --tile-size: 10px; /* Tambahkan ini agar bisa digunakan di CSS lain */
        }

        /* Reset dan Dasar */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body, html {
            width: 100%;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif; /* Menggunakan font Poppins dari profil.html */
            color: var(--game-text-light);
            overflow: hidden; /* Mencegah scroll horizontal dan vertikal */
            position: relative;

            /* Background yang diselaraskan dengan profil.html */
            background-color: var(--dark-background-solid);
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-blend-mode: overlay; /* Menambahkan efek overlay gelap */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Neon Border Effect for Body/Main Container (dari profil.html) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9); /* Background transparan agar gambar terlihat */
            z-index: -1;
            border: 2px solid var(--primary-neon-color);
            box-shadow: 0 0 15px var(--primary-neon-color), 0 0 25px var(--primary-neon-color), 0 0 40px var(--primary-neon-color);
            animation: neon-border-pulse 2s ease-in-out infinite alternate; /* Animasi untuk border */
        }

        @keyframes neon-border-pulse {
            from { border-color: rgba(0, 255, 255, 0.6); box-shadow: 0 0 40px rgba(0, 255, 255, 0.4), 0 0 80px rgba(0, 255, 255, 0.2), inset 0 0 20px rgba(0, 255, 255, 0.1); }
            to { border-color: rgba(0, 200, 200, 0.8); box-shadow: 0 0 50px rgba(0, 255, 255, 0.6), 0 0 100px rgba(0, 255, 255, 0.3), inset 0 0 25px rgba(0, 255, 255, 0.2); }
        }

        /* ========================================= */
        /* === HAMBURGER MENU (PROFIL) === */
        /* ========================================= */
        .hamburger-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            cursor: pointer;
            z-index: 10001; /* Di atas segalanya */
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            padding: 8px;
            box-shadow: 0 0 15px var(--secondary-neon-color);
            transition: all 0.3s ease;
        }

        .hamburger-icon:hover {
            box-shadow: 0 0 25px var(--secondary-neon-color);
            transform: scale(1.05);
        }

        .hamburger-icon span {
            display: block;
            width: 80%;
            height: 4px;
            background-color: var(--primary-neon-color);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-icon.open span:nth-child(1) {
            transform: translateY(10px) rotate(45deg);
        }
        .hamburger-icon.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger-icon.open span:nth-child(3) {
            transform: translateY(-10px) rotate(-45deg);
        }

        .sidebar-menu {
            position: fixed;
            top: 0;
            right: -350px; /* Sembunyikan di luar layar */
            width: 300px; /* Lebar sidebar */
            max-width: 90vw; /* Responsif untuk layar kecil */
            height: 100%;
            background: linear-gradient(180deg, rgba(0,0,0,0.95), rgba(10,0,10,0.95)); /* Background gelap transparan */
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Animasi bounce */
            z-index: 10000;
            padding: 20px;
            overflow-y: auto; /* Scroll jika konten melebihi tinggi */
            border-left: 2px solid var(--primary-neon-color);
            box-shadow: 0 0 25px var(--primary-neon-color), inset 0 0 10px rgba(0,255,255,0.1);
        }

        .sidebar-menu.open {
            right: 0; /* Tampilkan di layar */
        }

        /* Konten Profil di dalam Sidebar */
        .sidebar-menu h1 { /* Judul Game Classic dalam sidebar */
            font-family: 'Orbitron', sans-serif;
            color: var(--gold-neon-color);
            text-align: center;
            margin-bottom: 20px;
            animation: neon-glow 1.5s ease-in-out infinite alternate;
            background: linear-gradient(90deg, black 0%, #00bc 100%);
            padding: 10px 0;
            line-height: 1.2;
            font-size: 1.8em; /* Ukuran lebih kecil untuk sidebar */
        }
        @keyframes neon-glow {
            from { text-shadow: 0 0 10px var(--gold-neon-color), 0 0 20px rgba(255,215,0,0.7), 0 0 30px rgba(255,215,0,0.5); }
            to { text-shadow: 0 0 15px var(--gold-neon-color), 0 0 25px rgba(255,215,0,0.8), 0 0 40px rgba(255,215,0,0.6); }
        }

        .sidebar-menu .saldo {
            position: relative; /* Bukan absolute lagi agar ikut flow */
            top: auto;
            left: auto;
            margin-bottom: 20px; /* Jarak dari bawah */
            text-align: center;
            font-size: 1.1em;
        }

        .sidebar-menu .marquee-container {
            margin-bottom: 15px;
            font-size: 0.9em;
            background: linear-gradient(90deg, #222 0%, #00bc 100%);
            color: var(--gold-neon-color);
            border-top: 1px solid var(--secondary-neon-color);
            border-bottom: 1px solid var(--secondary-neon-color);
            box-shadow: 0 0 10px var(--success-neon-color);
        }

        .sidebar-menu .btn-group {
            flex-direction: column; /* Tombol vertikal */
            gap: 15px;
            margin-bottom: 25px;
        }

        .sidebar-menu .btn {
            width: 100%; /* Lebar penuh */
            max-width: none;
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--secondary-neon-color) 0%, var(--primary-neon-color) 100%);
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.6), 0 0 25px rgba(0, 188, 212, 0.4);
            border: 1px solid var(--gold-neon-color);
        }
        .sidebar-menu .btn:hover {
            background: var(--success-neon-color);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.8), 0 0 30px rgba(57, 255, 20, 0.5);
        }

        /* Logout button */
        #logout-btn {
            background: linear-gradient(90deg, #8B0000 0%, #DC143C 100%); /* Merah gelap ke merah cerah */
            color: #fff;
            margin-top: 30px;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 15px rgba(220, 20, 60, 0.6);
            transition: all 0.3s ease;
            width: 100%;
            display: block;
            text-transform: uppercase;
        }
        #logout-btn:hover {
            background: linear-gradient(90deg, #DC143C 0%, #FF6347 100%); /* Merah lebih terang */
            box-shadow: 0 0 25px rgba(255, 99, 71, 0.8);
            transform: translateY(-2px);
        }


        /* ========================================= */
        /* === MODAL STYLING (dari profil.html) === */
        /* ========================================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002; /* Lebih tinggi dari sidebar */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            color: #e0e0e0;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(224, 0, 255, 0.7), inset 0 0 15px rgba(224, 0, 255, 0.3);
            width: 90%;
            max-width: 480px;
            transform: translateY(-50px) scale(0.9);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease-out;
            position: relative;
            border: 2px solid rgba(224, 0, 255, 0.8);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-content h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--success-neon-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 0 0 15px rgba(57, 255, 20, 0.8);
            border-bottom: none;
            padding-bottom: 0;
            background: none;
            margin-left: 0;
            margin-right: 0;
            padding: 0;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-neon-color);
            font-size: 0.95em;
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.3);
        }

        .modal-content input[type="text"],
        .modal-content input[type="email"],
        .modal-content input[type="number"],
        .modal-content select {
            width: 100%;
            padding: 12px 18px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.4);
            background-color: rgba(0, 0, 0, 0.6);
            color: #e0e0e0;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal-content input:focus,
        .modal-content select:focus {
            outline: none;
            border-color: var(--success-neon-color);
            box-shadow: 0 0 0 4px rgba(57, 255, 20, 0.3), 0 0 15px rgba(57, 255, 20, 0.5);
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content input::placeholder {
            color: #888;
        }

        .modal-content input[readonly] {
            background-color: rgba(0, 0, 0, 0.4);
            border-color: rgba(0, 255, 255, 0.2);
            cursor: default;
        }

        .input-group-with-copy {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .input-group-with-copy label {
            margin-bottom: 0;
            flex-shrink: 0;
            white-space: nowrap;
            padding-right: 5px;
        }
        .input-group-with-copy input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0;
        }

        .btn-copy {
            background: var(--secondary-neon-color) !important;
            color: white !important;
            border-radius: 8px !important;
            padding: 8px 15px !important;
            font-size: 0.9em !important;
            box-shadow: 0 0 10px rgba(224, 0, 255, 0.6) !important;
            flex-shrink: 0;
            border: 1px solid rgba(224, 0, 255, 0.8);
            min-width: 80px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-copy:hover {
            background: var(--success-neon-color) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.8) !important;
            border-color: rgba(57, 255, 20, 1);
        }

        .modal-content button.primary {
            background: linear-gradient(90deg, var(--success-neon-color) 0%, var(--primary-neon-color) 100%);
            border: 2px solid #fff;
            padding: 12px 25px;
            border-radius: 10px;
            color: var(--game-text-dark);
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.6);
            margin-top: 15px;
            width: 100%;
        }

        .modal-content button.primary:hover {
            background: linear-gradient(90deg, var(--primary-neon-color) 0%, var(--success-neon-color) 100%);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.8);
            transform: translateY(-2px) scale(1.01);
        }

        .modal-content button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .modal-content button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--success-neon-color);
            border-color: var(--success-neon-color);
        }

        #form-qris {
            text-align: center;
            margin: 25px 0;
        }

        #gambar-qris {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            border: 3px solid var(--success-neon-color);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.7);
        }

        /* Tabel (dari profil.html) */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 20px;
            background: rgba(10, 10, 30, 0.7);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), inset 0 0 10px rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            color: #c0c0c0;
        }

        th {
            background: var(--primary-neon-color);
            color: var(--game-text-dark);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9em;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .status-pending { color: var(--gold-neon-color); font-weight: bold; }
        .status-approved { color: var(--success-neon-color); font-weight: bold; }
        .status-rejected { color: var(--error-neon-color); font-weight: bold; }

        /* Efek Loading Tombol */
        .btn.loading {
            position: relative;
            color: transparent;
            pointer-events: none;
            background: var(--primary-neon-color);
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin-top: -10px;
            margin-left: -10px;
            border: 3px solid var(--secondary-neon-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========================================= */
        /* === GAME STYLING (DISELARASKAN) === */
        /* ========================================= */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(180deg, #1c1c1c, #0a0a0a);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 40px var(--game-border-glow); /* Menggunakan warna neon game */
            border: 2px solid var(--game-border-glow); /* Menggunakan warna neon game */
            width: 95%;
            max-width: 480px;
            box-sizing: border-box;
            position: relative;
            z-index: 1; /* Pastikan di bawah menu hamburger */
        }

        h1.game-title { /* Judul khusus game */
            font-family: 'Press Start 2P', cursive;
            color: var(--game-accent-color);
            text-shadow: 0 0 15px var(--game-accent-color), 0 0 25px rgba(0, 224, 224, 0.5);
            font-size: 1.5em;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .info-item {
            font-size: 0.9em;
            margin: 8px 0;
            white-space: nowrap;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .info-item span {
            margin-left: 10px;
        }
        .info-item #totalKemenanganSesi {
            color: var(--game-tertiary-color);
            font-weight: bold;
        }
        .info-item #totalKekalahanDisplay {
            color: var(--game-primary-color);
            font-weight: bold;
        }
        .info-item #balance {
            color: var(--game-tertiary-color);
            font-weight: bold;
            font-size: 1.2em;
            display: inline-block;
            transition: color 0.1s ease-out;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        .info-item #balance.animate-gain {
            animation: balance-gain 0.5s ease-out;
        }
        .info-item #balance.animate-loss {
            animation: balance-loss 0.5s ease-out;
        }

        @keyframes balance-gain {
            0% { transform: scale(1); color: var(--game-primary-color); }
            50% { transform: scale(1.3); color: var(--game-tertiary-color); text-shadow: 0 0 10px var(--game-tertiary-color); }
            100% { transform: scale(1); color: var(--game-primary-color); text-shadow: none; }
        }

        @keyframes balance-loss {
            0% { transform: scale(1); color: var(--game-primary-color); }
            50% { transform: scale(1.3); color: #FF4444; text-shadow: 0 0 10px #FF4444; }
            100% { transform: scale(1); color: var(--game-primary-color); text-shadow: none; }
        }


        .player-banner {
            background-color: var(--game-canvas-bg);
            border: 2px solid var(--game-accent-color);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1em;
            color: var(--game-accent-color);
            text-align: left;
            box-shadow: inset 0 0 10px rgba(0, 224, 224, 0.3);
        }
        .player-banner p {
            margin: 0;
            padding: 3px 0;
            display: flex;
            justify-content: space-between;
        }
        .player-banner .player-name {
            font-weight: bold;
            color: var(--game-tertiary-color);
        }
        .player-banner .player-status {
            font-size: 0.8em;
            color: #AAAAAA;
        }
        canvas {
            background-color: var(--game-canvas-bg);
            border: 2px solid var(--game-accent-color);
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 224, 224, 0.6);
            display: block;
        }

        .controls {
            display: grid;
            grid-template-areas: "left rotate right";
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            width: 100%;
            margin-top: 25px;
        }

        .controls button {
            background-color: var(--game-button-bg);
            color: var(--game-text-dark);
            border: none;
            padding: 15px 0;
            font-size: 1.8em;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            box-shadow: 0 6px 0 var(--game-button-active);
            -webkit-tap-highlight-color: transparent;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .controls button:active {
            background-color: var(--game-button-active);
            transform: translateY(3px);
            box-shadow: 0 3px 0 var(--game-button-active);
        }

        .bet-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 15px;
            gap: 10px;
            font-size: 1em;
            display: none; /* Default hidden, ditampillkan oleh JS */
        }

        .bet-controls button {
            background-color: var(--game-secondary-color);
            color: var(--game-text-light);
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.1s ease;
            box-shadow: 0 4px 0 #4C4CBB;
            -webkit-tap-highlight-color: transparent;
        }
        .bet-controls button:active {
            background-color: #4C4CBB;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3B3B88;
        }

        .bet-controls span {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--game-accent-color);
            text-shadow: 0 0 5px var(--game-accent-color);
            min-width: 80px;
            text-align: center;
        }

        #backToProfileBtn { /* Ini sekarang tombol untuk membuka sidebar */
            margin-top: 25px;
            width: 100%;
            background-color: var(--gold-neon-color); /* Warna diselaraskan */
            color: var(--game-text-dark);
            font-size: 1.2em;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            box-shadow: 0 6px 0 #CCAA00;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            display: none; /* Default hidden, ditampillkan oleh JS */
        }

        #backToProfileBtn:active {
            background-color: #CCAA00;
            transform: translateY(3px);
            box-shadow: 0 3px 0 #997A00;
        }

        .message-area {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--game-text-light);
            min-height: 30px;
            text-align: center;
            text-shadow: 0 0 8px rgba(0,0,0,0.7);
            padding: 5px;
        }
        .message-area.info {
            color: var(--game-accent-color);
            text-shadow: 0 0 10px var(--game-accent-color);
        }
        .message-area.success {
            color: var(--game-tertiary-color);
            text-shadow: 0 0 10px var(--game-tertiary-color);
        }
        .message-area.error {
            color: var(--game-primary-color);
            text-shadow: 0 0 10px var(--game-primary-color);
        }

        .win-message-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.1);
            opacity: 0;
            color: var(--gold-neon-color);
            font-size: 1em;
            font-weight: bold;
            text-shadow: 0 0 15px var(--gold-neon-color), 0 0 25px orange;
            z-index: 1000;
            text-align: center;
            animation: none;
            font-family: 'Press Start', cursive; /* Pastikan pakai font game */
        }

        .win-message-overlay.animate {
            animation: zoomWin 1.8s ease-out forwards;
        }

        @keyframes zoomWin {
            0% {
                transform: translate(-50%, -50%) scale(0.1);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        /* Media Queries untuk Responsif */
        @media (max-width: 768px) {
            .hamburger-icon {
                top: 15px;
                right: 15px;
                width: 35px;
                height: 35px;
                padding: 6px;
            }
            .hamburger-icon span {
                height: 3px;
            }
            .hamburger-icon.open span:nth-child(1) { transform: translateY(8px) rotate(45deg); }
            .hamburger-icon.open span:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

            .sidebar-menu {
                width: 280px;
                padding: 15px;
            }
            .sidebar-menu h1 {
                font-size: 1.5em;
            }
            .sidebar-menu .saldo {
                font-size: 1em;
            }
            .sidebar-menu .marquee-container {
                font-size: 0.8em;
            }
            .sidebar-menu .btn {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            #logout-btn {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            .modal-content {
                padding: 25px;
                border-radius: 15px;
            }
            .modal-content h2 {
                font-size: 1.8em;
            }
            .modal-content button.primary,
            .modal-content button.secondary {
                font-size: 1em;
                padding: 10px 20px;
            }
            .btn-copy {
                font-size: 0.8em !important;
                padding: 6px 10px !important;
                min-width: 60px;
            }
            .input-group-with-copy {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .input-group-with-copy label,
            .input-group-with-copy input[type="text"],
            .btn-copy {
                width: 100%;
            }

            .game-container {
                padding: 15px;
                width: 98%;
            }
            h1.game-title {
                font-size: 1.3em;
            }
            .info-item {
                font-size: 0.8em;
            }
            .player-banner {
                padding: 10px 12px;
            }
            .controls button {
                padding: 12px 0;
                font-size: 1.5em;
                height: 50px;
            }
            .bet-controls button {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            .bet-controls span {
                font-size: 1.1em;
            }
            #backToProfileBtn {
                padding: 12px 20px;
                font-size: 1em;
            }
            .message-area {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .hamburger-icon {
                top: 10px;
                right: 10px;
                width: 30px;
                height: 30px;
                padding: 5px;
            }
            .hamburger-icon span {
                height: 2px;
            }
            .hamburger-icon.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
            .hamburger-icon.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

            .sidebar-menu {
                width: 250px;
                padding: 10px;
            }
            .sidebar-menu h1 {
                font-size: 1.2em;
            }
            .sidebar-menu .saldo {
                font-size: 0.9em;
            }
            .sidebar-menu .marquee-container {
                font-size: 0.7em;
            }
            .sidebar-menu .btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }
            #logout-btn {
                padding: 8px 12px;
                font-size: 0.8em;
            }
            .modal-content {
                padding: 20px;
                border-radius: 12px;
            }
            .modal-content h2 {
                font-size: 1.5em;
            }
            .modal-content button.primary,
            .modal-content button.secondary {
                font-size: 0.9em;
                padding: 8px 15px;
            }
            .btn-copy {
                font-size: 0.7em !important;
                padding: 5px 8px !important;
                min-width: 50px;
            }

            .game-container {
                padding: 10px;
            }
            h1.game-title {
                font-size: 1.1em;
            }
            .info-item {
                font-size: 0.7em;
            }
            .player-banner {
                padding: 8px 10px;
            }
            .controls button {
                padding: 10px 0;
                font-size: 1.2em;
                height: 45px;
            }
            .bet-controls button {
                padding: 6px 10px;
                font-size: 0.8em;
            }
            .bet-controls span {
                font-size: 1em;
            }
            #backToProfileBtn {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            .message-area {
                font-size: 0.9em;
            }
        }

    </style>
</head>
<body>
    <div id="hamburger-icon" class="hamburger-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div id="sidebar-menu" class="sidebar-menu">
        <div class="saldo" id="saldo-display-sidebar">Saldo: Rp.0</div>
        <h1>GAME CLASIC</h1>
        <div class="marquee-container">
            <marquee> ⚠️•penting untuk mengecek rekening/nomor deposit bandar dan nomor penerima penarikan ('nomor anda') agar proses berjalan lancar. Game Zone tidak akan memproses deposit ke nomor lain dan tidak memproses withdraw kembali jika ada kesalah input nomor penerima withdraw•⚠️</marquee>
        </div>

        <div class="btn-group">
            <button class="btn" id="btn-deposit">Deposit</button>
            <button class="btn" id="btn-withdraw">Penarikan</button>
            <button class="btn" id="btn-history">Riwayat</button>
        </div>
        <button id="logout-btn">Logout</button>
    </div>

    <div class="game-container">
        <div class="player-banner">
            <p>Pemain: <span id="playerName" class="player-name">Memuat...</span></p>
            <p>Status: <span id="playerStatus" class="player-status">Memeriksa Login...</span></p>
            <p class="info-item">Kemenangan: <span id="totalKemenanganSesi">0</span></p>
            <p class="info-item">Kekalahan: <span id="totalKekalahanDisplay">0</span></p>
            <p class="info-item">Saldo: <span id="balance">Memuat...</span></p>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="winMessage" class="win-message-overlay"></div>

        <div class="controls">
            <button id="moveLeftBtn" class="control-btn">←</button>
            <button id="rotateBtn" class="control-btn">↻</button>
            <button id="moveRightBtn" class="control-btn">→</button>
        </div>

        <div class="bet-controls">
            <button id="decreaseBetBtn">-</button>
            <span id="currentBetDisplay">Bet: Rp0</span>
            <button id="increaseBetBtn">+</button>
        </div>

        <button id="backToProfileBtn" style="display:none;">Buka Menu</button>
        <div id="message-area" class="message-area"></div>
    </div>

    <audio id="clickSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
    <audio id="lineClearSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-mechanical-crate-pick-up-3154%20(1).mp3" preload="auto"></audio>
    <audio id="blockLandSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//dj-background-music-background-music-free-music-music-free-for-use-221916%20(1).mp3" preload="auto" loop></audio>

    <div id="modal-deposit" class="modal-overlay">
        <div class="modal-content">
            <h2>DEPOSIT VIA DANA</h2>
            <label for="dep-nama">Nama Penerima:</label>
            <input type="text" id="dep-nama" placeholder="Nama" readonly />

            <label for="dep-email">Email Pemain:</label>
            <input type="email" id="dep-email" placeholder="Email" readonly />

            <div class="input-group-with-copy">
                <label for="dep-nomor">Nomor Tujuan:</label>
                <input type="text" id="dep-nomor" placeholder="Nomor" readonly />
                <button class="btn-copy" data-target="dep-nomor">
                    <i class="fas fa-copy"></i> Salin nomor
                </button>
            </div>

            <div style="text-align:center; margin: 25px 0;">
                <button class="secondary" id="btn-qris">deposit via Qris</button>
                <button class="secondary" id="btn-kembali-ewallet" style="display:none;">Kembali eWallet</button>
            </div>

            <div id="form-qris" style="display:none;">
                <img src="" alt="QRIS" id="gambar-qris" />
            </div>

            <label for="dep-jumlah">Jumlah (Rp):</label>
            <input type="number" id="dep-jumlah" placeholder="Contoh: 50000" />

            <button class="primary" id="dep-submit">Kirim</button>
            <button class="secondary" onclick="closeModal('modal-deposit')">Batal</button>
        </div>
    </div>

    <div id="modal-withdraw" class="modal-overlay">
        <div class="modal-content">
            <h2>PENARIKAN DANA</h2>

            <label for="with-username">Username:</label>
            <input type="text" id="with-username" placeholder="Username Anda" readonly />

            <label for="with-email">Email:</label>
            <input type="email" id="with-email" placeholder="Email Anda" readonly />

            <label for="with-metode-display">Metode Pembayaran:</label>
            <input type="text" id="with-metode-display" placeholder="Metode Anda" readonly />
            <input type="hidden" id="with-metode-hidden" />

            <label for="with-nomor-akun-display">Nomor Akun/Rekening:</label>
            <input type="text" id="with-nomor-akun-display" placeholder="Nomor Akun Anda" readonly />
            <input type="hidden" id="with-nomor-akun-hidden" />

            <label for="with-bank-display" id="label-bank-display" style="display:none;">Nama Bank:</label>
            <input type="text" id="with-bank-display" placeholder="Nama Bank Anda" readonly style="display:none;" />
            <input type="hidden" id="with-bank-hidden" />


            <label for="with-jumlah">Jumlah (Rp):</label>
            <input type="number" id="with-jumlah" placeholder="Contoh: 100000" />

            <button class="primary" id="with-submit">Kirim</button>
            <button class="secondary" onclick="closeModal('modal-withdraw')">Batal</button>
        </div>
    </div>

    <div id="modal-history" class="modal-overlay">
        <div class="modal-content">
            <h2>RIWAYAT TRANSAKSI</h2>
            <div id="history-content">
                <h3>Riwayat Deposit</h3>
                <table id="riwayat-deposit-modal">
                    <thead><tr><th>Tanggal</th><th>Jumlah (Rp)</th><th>Status</th></tr></thead>
                    <tbody><tr><td colspan="3" class="empty">Memuat data...</td></tr></tbody>
                </table>

                <h3>Riwayat Penarikan</h3>
                <table id="riwayat-penarikan-modal">
                    <thead><tr><th>Tanggal</th><th>Jumlah (Rp)</th><th>Status</th></tr></thead>
                    <tbody><tr><td colspan="3" class="empty">Memuat data...</td></tr></tbody>
                </table>
            </div>
            <div class="modal-buttons">
                <button class="secondary" onclick="closeModal('modal-history')">Tutup</button>
            </div>
        </div>
    </div>
       <div id="custom-alert-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="custom-alert-title" style="font-family: 'Orbitron', sans-serif;"></h2>
            <p id="custom-alert-message" style="text-align: center; margin-bottom: 25px; color: #ccc;"></p>
            <div class="modal-buttons">
                <button class="primary" id="custom-alert-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================
        // === SUPABASE CONFIGURATION ===
        // =========================================
        const SUPABASE_URL = 'https://vqmfachxnjyxwuavpgds.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let uid = localStorage.getItem('uid'); // Ini harusnya di-set setelah login berhasil

        // =========================================
        // === GAME SCRIPT (dari susunbalok.html) ===
        // =========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const totalKemenanganSesiDisplay = document.getElementById('totalKemenanganSesi');
        const totalKekalahanDisplay = document.getElementById('totalKekalahanDisplay');
        const balanceDisplay = document.getElementById('balance');
        const messageArea = document.getElementById('message-area');
        const playerNameDisplay = document.getElementById('playerName');
        const playerStatusDisplay = document.getElementById('playerStatus');

        const moveLeftBtn = document.getElementById('moveLeftBtn');
        const rotateBtn = document.getElementById('rotateBtn');
        const moveRightBtn = document.getElementById('moveRightBtn');
        const backToProfileBtn = document.getElementById('backToProfileBtn'); // Sekarang tombol "Buka Menu"

        const currentBetDisplay = document.getElementById('currentBetDisplay');
        const decreaseBetBtn = document.getElementById('decreaseBetBtn');
        const increaseBetBtn = document.getElementById('increaseBetBtn');
        const winMessageDiv = document.getElementById('winMessage');

        const TILE_SIZE = 20;
        const BOARD_WIDTH = 14;
        const BOARD_HEIGHT = 20;

        canvas.width = BOARD_WIDTH * TILE_SIZE;
        canvas.height = BOARD_HEIGHT * TILE_SIZE;

        let totalKemenanganSesi = 0;
        let totalKekalahan = 0;
        let currentBalance = 0;
        let currentUser = null;
        let gameRunning = false;
        let board = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(0));
        let currentPiece = null;
        let currentX = 0;
        let currentY = 0;
        let highestKemenangan = 0;

        const clickSound = document.getElementById('clickSound');
        const lineClearSound = document.getElementById('lineClearSound');
        const blockLandSound = document.getElementById('blockLandSound');
        const backgroundMusic = document.getElementById('backgroundMusic');

        let currentBet = 200;
        const MIN_BET = 200;
        const MAX_BET = 1000;
        const BET_INCREMENT = 100;
        const BASE_VALUE_PER_BLOCK_SQUARE = 50;
        const GAME_START_COST = 0;

        function playSound(audioElement) {
            if (audioElement) {
                audioElement.currentTime = 0;
                audioElement.play().catch(e => console.warn("Audio Playback Warning:", e.message));
            }
        }

        function playBackgroundMusic() {
            if (backgroundMusic && backgroundMusic.paused) {
                backgroundMusic.play().catch(e => {
                    console.warn("Autoplay of background music blocked. User interaction required. Error:", e.message);
                });
            }
        }

        async function initializeUserAndSaldo() {
            playerNameDisplay.textContent = 'Memuat...';
            playerStatusDisplay.textContent = 'Memeriksa Login...';
            showMessage('Memeriksa sesi pengguna...', 'info');

            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();

                if (authError) {
                    console.error('Supabase Auth Error:', authError.message);
                    playerStatusDisplay.textContent = 'Auth Error';
                    showMessage(`Gagal otentikasi: ${authError.message}. Silakan login ulang.`, 'error');
                    setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                    return;
                }

                if (user) {
                    currentUser = user;
                    uid = user.id; // Pastikan uid terupdate
                    localStorage.setItem('uid', user.id); // Simpan uid
                    playerNameDisplay.textContent = user.user_metadata?.username || user.email || 'Pemain';
                    playerStatusDisplay.textContent = 'Login';
                    console.log('User logged in:', currentUser.id);
                    await fetchSaldoAndKemenangan();
                } else {
                    console.warn('No active user session. Redirecting to login.');
                    playerStatusDisplay.textContent = 'Tidak Login';
                    showMessage('Anda belum login. Mengarahkan ke halaman login...', 'info');
                    setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                }
            } catch (error) {
                console.error('Unexpected error during user initialization:', error.message);
                playerStatusDisplay.textContent = 'Error Inisialisasi';
                showMessage(`Error inisialisasi user: ${error.message}. Periksa Supabase config/CORS.`, 'error');
                backToProfileBtn.style.display = 'block'; // Tampilkan tombol "Buka Menu"
            }
        }

        async function fetchSaldoAndKemenangan() {
            if (!currentUser) {
                showMessage('Error: Tidak ada user aktif untuk mengambil saldo/kemenangan.', 'error');
                return;
            }
            showMessage('Memuat data pemain...', 'info');
            balanceDisplay.textContent = 'Memuat...';
            document.getElementById('saldo-display-sidebar').textContent = 'Saldo: Memuat...'; // Update saldo di sidebar juga
            totalKemenanganSesiDisplay.textContent = 'Memuat...';
            totalKekalahanDisplay.textContent = 'Memuat...';

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .select('saldo, username, highest_kemenangan')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Error fetching data:', error.message);
                    if (error.code === 'PGRST116' || error.message.includes('0 rows')) {
                        console.warn('User entry not found in users_data. Creating new entry with default saldo...');
                        const usernameFromMeta = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Unknown';
                        await createNewUserEntryWithDefaultSaldo(currentUser.id, currentUser.email, usernameFromMeta);
                        await fetchSaldoAndKemenangan();
                    } else {
                        showMessage(`Gagal memuat data: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                        balanceDisplay.textContent = 'Gagal';
                        document.getElementById('saldo-display-sidebar').textContent = 'Saldo: Gagal';
                        totalKemenanganSesiDisplay.textContent = 'Gagal';
                        totalKekalahanDisplay.textContent = 'Gagal';
                        backToProfileBtn.style.display = 'block'; // Tampilkan tombol "Buka Menu"
                    }
                    return;
                }

                if (data) {
                    currentBalance = data.saldo || 0;
                    balanceDisplay.textContent = `Rp.${currentBalance.toLocaleString('id-ID')}`;
                    document.getElementById('saldo-display-sidebar').textContent = `Saldo: Rp.${currentBalance.toLocaleString('id-ID')}`;
                    playerNameDisplay.textContent = data.username || currentUser.user_metadata?.username || currentUser.email || 'Pemain';
                    highestKemenangan = data.highest_kemenangan || 0;
                    totalKemenanganSesiDisplay.textContent = '0'; // Reset per sesi game
                    totalKekalahanDisplay.textContent = '0'; // Reset per sesi game

                    showMessage('Data pemain dimuat!', 'success');
                    console.log('Saldo fetched:', currentBalance, 'Highest Kemenangan:', highestKemenangan);

                    currentBetDisplay.textContent = `Bet: Rp${currentBet.toLocaleString('id-ID')}`;

                    if (currentBalance >= (GAME_START_COST > 0 ? GAME_START_COST : MIN_BET)) { // Cek saldo untuk start game atau minimal bet
                        showMessage(`Siap! Saldo Anda: Rp${currentBalance.toLocaleString('id-ID')}.`, 'info');
                        startGamePrompt();
                    } else {
                        showMessage(`Saldo Anda tidak cukup (Rp${currentBalance.toLocaleString('id-ID')}). Perlu minimal Rp${MIN_BET.toLocaleString('id-ID')} untuk bermain! Top up untuk bermain!`, 'error');
                        balanceDisplay.classList.add('animate-loss');
                        setTimeout(() => balanceDisplay.classList.remove('animate-loss'), 500);
                        backToProfileBtn.style.display = 'block'; // Tampilkan tombol "Buka Menu"
                    }
                }

            } catch (err) {
                console.error('Unexpected error in fetchSaldoAndKemenangan:', err);
                showMessage('Terjadi kesalahan tak terduga saat memuat data pemain.', 'error');
                balanceDisplay.textContent = 'Error';
                document.getElementById('saldo-display-sidebar').textContent = 'Saldo: Error';
                totalKemenanganSesiDisplay.textContent = 'Error';
                totalKekalahanDisplay.textContent = 'Error';
                backToProfileBtn.style.display = 'block'; // Tampilkan tombol "Buka Menu"
            }
        }

        async function createNewUserEntryWithDefaultSaldo(userId, email, username) {
            const DEFAULT_STARTING_SALDO = 5000;
            const DEFAULT_HIGHEST_KEMENANGAN = 0;

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .insert([
                        { user_id: userId, saldo: DEFAULT_STARTING_SALDO, email: email, username: username, peran: 'Players_Guest', highest_kemenangan: DEFAULT_HIGHEST_KEMENANGAN }
                    ]);

                if (error) {
                    console.error('Error creating new user entry:', error.message);
                    showMessage(`Gagal membuat entry user baru: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                    return false;
                }
                console.log('New user entry created with default saldo:', DEFAULT_STARTING_SALDO);
                currentBalance = DEFAULT_STARTING_SALDO;
                highestKemenangan = DEFAULT_HIGHEST_KEMENANGAN;
                balanceDisplay.textContent = `Rp.${currentBalance.toLocaleString('id-ID')}`;
                document.getElementById('saldo-display-sidebar').textContent = `Saldo: Rp.${currentBalance.toLocaleString('id-ID')}`;
                totalKemenanganSesiDisplay.textContent = '0';
                totalKekalahanDisplay.textContent = '0';
                showMessage('User baru dibuat dengan saldo awal!', 'success');
                return true;
            } catch (err) {
                console.error('Unexpected error in createNewUserEntryWithDefaultSaldo:', err);
                showMessage('Terjadi kesalahan tak terduga saat membuat user baru.', 'error');
                return false;
            }
        }

        let updateSaldoTimeout;
        async function updateSaldo(amount, updateDB = true) {
            currentBalance += amount;
            balanceDisplay.textContent = `Rp.${currentBalance.toLocaleString('id-ID')}`;
            document.getElementById('saldo-display-sidebar').textContent = `Saldo: Rp.${currentBalance.toLocaleString('id-ID')}`;
            addBalanceAnimation(amount > 0 ? 'gain' : 'loss');

            if (amount > 0) {
                totalKemenanganSesi += amount;
                updateTotalKemenanganSesiDisplay();
            } else {
                totalKekalahan += Math.abs(amount);
                updateTotalKekalahanDisplay();
            }

            if (!currentUser || !updateDB) {
                console.log('Saldo lokal diperbarui, namun tidak ke DB (user tidak ada atau updateDB=false).');
                return;
            }

            clearTimeout(updateSaldoTimeout);
            updateSaldoTimeout = setTimeout(async () => {
                try {
                    const { data, error } = await supabase
                        .from('users_data')
                        .update({ saldo: currentBalance })
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error updating saldo:', error.message);
                        showMessage(`Gagal update saldo: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                        return;
                    }
                    console.log('Saldo updated successfully to DB:', currentBalance);
                } catch (err) {
                    console.error('Unexpected error in updateSaldo:', err);
                    showMessage('Terjadi kesalahan tak terduga saat update saldo.', 'error');
                }
            }, 500);
        }
        async function saveHighestKemenangan(newKemenangan) {
            if (!currentUser) {
                console.warn('Tidak bisa menyimpan kemenangan tertinggi: Tidak ada user login.');
                return;
            }
            if (newKemenangan <= highestKemenangan) {
                console.log('Kemenangan baru tidak lebih tinggi dari kemenangan tertinggi yang ada.');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .update({ highest_kemenangan: newKemenangan })
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Error saving highest kemenangan:', error.message);
                    showMessage(`Gagal menyimpan kemenangan tertinggi: ${error.message}`, 'error');
                } else {
                    highestKemenangan = newKemenangan;
                    console.log('Kemenangan tertinggi berhasil disimpan:', newKemenangan);
                    showMessage(`Kemenangan tertinggi baru: ${newKemenangan}!`, 'success');
                }
            } catch (err) {
                console.error('Unexpected error in saveHighestKemenangan:', err);
                showMessage('Terjadi kesalahan tak terduga saat menyimpan kemenangan tertinggi.', 'error');
            }
        }

        const TETROMINOS = [
            { shape: [[0, 1, 0], [1, 1, 1], [0, 0, 0]], color: '#FF00FF' }, // T
            { shape: [[1, 1, 0], [0, 1, 1], [0, 0, 0]], color: '#00FF00' }, // S
            { shape: [[0, 1, 1], [1, 1, 0], [0, 0, 0]], color: '#FF0000' }, // Z
            { shape: [[1, 1], [1, 1]], color: '#FFFF00' }, // O
            { shape: [[1, 0, 0], [1, 1, 1], [0, 0, 0]], color: '#FFA500' }, // L
            { shape: [[0, 0, 1], [1, 1, 1], [0, 0, 0]], color: '#0000FF' }, // J
            { shape: [[1], [1], [1], [1]], color: '#00FFFF' } // I
        ];

        function showMessage(msg, type = 'info') {
            messageArea.textContent = msg;
            messageArea.className = `message-area ${type}`;
            setTimeout(() => {
                messageArea.textContent = '';
                messageArea.className = `message-area`;
            }, 3000);
        }

        function addBalanceAnimation(type) {
            balanceDisplay.classList.remove('animate-gain', 'animate-loss');
            void balanceDisplay.offsetWidth;
            balanceDisplay.classList.add(`animate-${type}`);
        }

        function showWinAnimation(score, multiplier) {
            const winMessageDiv = document.getElementById('winMessage');
            winMessageDiv.textContent = `${score.toLocaleString('id-ID')} (${multiplier}x)`;
            winMessageDiv.classList.add('animate');

            winMessageDiv.addEventListener('animationend', () => {
                winMessageDiv.classList.remove('animate');
            }, { once: true });
        }

        function getRandomPiece() {
            const randomIndex = Math.floor(Math.random() * TETROMINOS.length);
            const piece = JSON.parse(JSON.stringify(TETROMINOS[randomIndex]));

            const MULTIPLIER_CHANCE = 0.10;
            if (Math.random() < MULTIPLIER_CHANCE) {
                const numSquares = piece.shape.flat().filter(s => s === 1).length;
                if (numSquares > 0) {
                    let placedMultiplier = false;
                    let attempts = 0;
                    const maxAttempts = 10;
                    while (!placedMultiplier && attempts < maxAttempts) {
                        const randomRow = Math.floor(Math.random() * piece.shape.length);
                        const randomCol = Math.floor(Math.random() * piece.shape[randomRow].length);

                        if (piece.shape[randomRow][randomCol] === 1) {
                            piece.shape[randomRow][randomCol] = 'multiplier';
                            piece.multiplierValue = Math.floor(Math.random() * (100 - 2 + 1)) + 2;
                            placedMultiplier = true;
                        }
                        attempts++;
                    }
                }
            }
            return piece;
        }

        function drawBoard() {
            for (let row = 0; row < BOARD_HEIGHT; row++) {
                for (let col = 0; col < BOARD_WIDTH; col++) {
                    if (board[row][col] !== 0) {
                        ctx.fillStyle = board[row][col].color;
                        ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-block-border');
                        ctx.strokeRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        if (board[row][col].multiplier) {
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-text-dark');
                            ctx.font = `${0.7 * TILE_SIZE}px 'Press Start'`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`${board[row][col].multiplier}`, (col + 0.5) * TILE_SIZE, (row + 0.5) * TILE_SIZE);
                        }
                    } else {
                        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-canvas-bg');
                        ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = '#222';
                        ctx.strokeRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }
        function drawPiece(piece, x, y) {
            if (!piece) return;
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        ctx.fillStyle = piece.color;
                        ctx.fillRect((x + col) * TILE_SIZE, (y + row) * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-block-border');
                        ctx.strokeRect((x + col) * TILE_SIZE, (y + row) * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        if (piece.shape[row][col] === 'multiplier') {
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--game-text-dark');
                            ctx.font = `${0.7 * TILE_SIZE}px 'Press Start'`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`${piece.multiplierValue}`, (x + col + 0.5) * TILE_SIZE, (y + row + 0.5) * TILE_SIZE);
                        }
                    }
                }
            }
        }

        function isValidMove(piece, newX, newY) {
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        const boardX = newX + col;
                        const boardY = newY + row;

                        if (boardX < 0 || boardX >= BOARD_WIDTH || boardY >= BOARD_HEIGHT) {
                            return false;
                        }
                        if (boardY >= 0 && board[boardY][boardX] !== 0) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function placePiece() {
            for (let row = 0; row < currentPiece.shape.length; row++) {
                for (let col = 0; col < currentPiece.shape[row].length; col++) {
                    if (currentPiece.shape[row][col]) {
                        if (currentY + row < 0) {
                            gameOver();
                            return;
                        }
                        let cellData = {
                            color: currentPiece.color,
                            clear_value_per_block: BASE_VALUE_PER_BLOCK_SQUARE
                        };
                        if (currentPiece.shape[row][col] === 'multiplier') {
                            cellData.multiplier = currentPiece.multiplierValue;
                        }
                        board[currentY + row][currentX + col] = cellData;
                    }
                }
            }
            playSound(blockLandSound);
            clearLines();
            createNewPiece();
        }

        function rotatePiece(piece) {
            const newShape = Array(piece.shape[0].length).fill(null).map(() => Array(piece.shape.length).fill(0));
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    newShape[col][piece.shape.length - 1 - row] = piece.shape[row][col];
                }
            }
            const newPiece = { ...piece, shape: newShape };
            return newPiece;
        }

        function clearLines() {
    let linesCleared = 0; // Jumlah baris yang berhasil dipecahkan
    let totalSquaresClearedInLine = 0; // Total kotak yang terhapus di semua baris yang pecah
    let totalMultiplierFromClearedLines = 0; // **Variabel baru: Menjumlahkan semua nilai multiplier yang ditemukan**
    let hasMultiplierBeenFound = false; // **Flag baru: Untuk menandai apakah ada multiplier yang ditemukan di baris yang pecah**

    // Loop dari baris paling bawah ke atas
    for (let row = BOARD_HEIGHT - 1; row >= 0; row--) {
        // Cek apakah baris ini penuh (tidak ada sel yang bernilai 0)
        if (board[row].every(cell => cell !== 0)) {
            linesCleared++; // Tambah jumlah baris yang dipecahkan

            // Loop melalui setiap kolom di baris yang akan dihapus ini
            for (let col = 0; col < BOARD_WIDTH; col++) {
                totalSquaresClearedInLine++; // Tambah jumlah kotak yang terhapus

                // Cek apakah sel ini ada dan memiliki properti 'multiplier'
                if (board[row][col] && board[row][col].multiplier) {
                    // Jika ada, tambahkan nilai multiplier-nya ke total
                    totalMultiplierFromClearedLines += board[row][col].multiplier;
                    hasMultiplierBeenFound = true; // Set flag menjadi true karena multiplier ditemukan
                }
            }

            // Geser baris-baris di atas ke bawah
            for (let r = row; r > 0; r--) {
                board[r] = [...board[r - 1]]; // Salin baris di atasnya
            }
            board[0] = Array(BOARD_WIDTH).fill(0); // Buat baris paling atas menjadi kosong

            row++; // Penting: Tetap di baris yang sama karena baris baru telah jatuh ke posisi ini
        }
    }

    // Jika ada baris yang berhasil dipecahkan
    if (linesCleared > 0) {
        playSound(lineClearSound); // Mainkan suara pembersihan baris

        // Hitung poin dasar yang didapat
        let pointsEarned = totalSquaresClearedInLine * BASE_VALUE_PER_BLOCK_SQUARE;

        // **Jika ada multiplier yang ditemukan, terapkan jumlah total multiplier ke poin**
        if (hasMultiplierBeenFound) {
            pointsEarned *= totalMultiplierFromClearedLines;
        } else {
            // Jika tidak ada multiplier, pastikan poin tidak berubah (dikali 1)
            pointsEarned *= 1;
        }

        updateSaldo(pointsEarned); // Perbarui saldo pemain
        showMessage(`+Rp.${pointsEarned.toLocaleString('id-ID')} dari ${linesCleared} baris!`, 'success'); // Tampilkan pesan kemenangan

        // Perbarui animasi kemenangan, berikan total multiplier jika ada, atau 1 jika tidak ada
        showWinAnimation(pointsEarned, hasMultiplierBeenFound ? totalMultiplierFromClearedLines : 1);
    }
}


        function updateTotalKemenanganSesiDisplay() {
            totalKemenanganSesiDisplay.textContent = totalKemenanganSesi.toLocaleString('id-ID');
        }

        function updateTotalKekalahanDisplay() {
            totalKekalahanDisplay.textContent = totalKekalahan.toLocaleString('id-ID');
        }

        function updateBalanceDisplay() {
            balanceDisplay.textContent = `Rp.${currentBalance.toLocaleString('id-ID')}`;
            document.getElementById('saldo-display-sidebar').textContent = `Saldo: Rp.${currentBalance.toLocaleString('id-ID')}`;
        }

        function createNewPiece() {
            currentPiece = getRandomPiece();
            currentY = 0;
            currentX = Math.floor(BOARD_WIDTH / 2) - Math.floor(currentPiece.shape[0].length / 2);

            const costPerBlockDrop = currentBet;

            if (currentBalance < costPerBlockDrop) {
                showMessage(`Saldo tidak cukup untuk balok ini (perlu Rp.${costPerBlockDrop.toLocaleString('id-ID')})!`, 'error');
                gameOver();
                return;
            }

            updateSaldo(-costPerBlockDrop);
            showMessage(`-${costPerBlockDrop.toLocaleString('id-ID')} Saldo. Sisa: Rp.${currentBalance.toLocaleString('id-ID')}`, 'info');

            if (!isValidMove(currentPiece, currentX, currentY)) {
                gameOver();
            }
        }
        let dropInterval = 200;
        let lastDropTime = 0;
        let animationFrameId = null;

        function gameLoop(timestamp) {
            if (!gameRunning) {
                cancelAnimationFrame(animationFrameId);
                return;
            }

            if (!lastDropTime) lastDropTime = timestamp;
            const deltaTime = timestamp - lastDropTime;

            if (deltaTime > dropInterval) {
                if (isValidMove(currentPiece, currentX, currentY + 1)) {
                    currentY++;
                } else {
                    placePiece();
                }
                lastDropTime = timestamp;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBoard();
            drawPiece(currentPiece, currentX, currentY);

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startGamePrompt() {
            hideGameControls();
            document.querySelector('.bet-controls').style.display = 'flex';

            const startButton = document.createElement('button');
            startButton.textContent = `Mulai Game`;
            startButton.id = 'startButton';
            startButton.style.cssText = `
                margin-top: 20px;
                width: 100%;
                background-color: var(--game-tertiary-color);
                color: var(--game-text-dark);
                font-size: 1.2em;
                padding: 15px 25px;
                border-radius: 8px;
                cursor: pointer;
                border: none;
                box-shadow: 0 4px 0 #4CAF50;
                transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            `;
            startButton.onmouseover = () => startButton.style.backgroundColor = '#8BC34A';
            startButton.onmouseout = () => startButton.style.backgroundColor = 'var(--game-tertiary-color)';
            startButton.onmousedown = () => { startButton.style.transform = 'translateY(2px)'; startButton.style.boxShadow = '0 2px 0 #4CAF50'; };
            startButton.onmouseup = () => { startButton.style.transform = 'translateY(0)'; startButton.style.boxShadow = '0 4px 0 #4CAF50'; };
            startButton.onclick = initiateGameStart;

            document.querySelector('.game-container').insertBefore(startButton, document.querySelector('.controls'));
            showMessage('Klik "Mulai Game" untuk bermain.', 'info');

            backToProfileBtn.style.display = 'block'; // Tampilkan tombol "Buka Menu"
        }
        async function initiateGameStart() {
            playSound(clickSound);
            document.getElementById('startButton')?.remove();

            if (GAME_START_COST > 0 && currentBalance < GAME_START_COST) {
                showMessage(`Saldo Anda tidak cukup (Rp${currentBalance.toLocaleString('id-ID')}). Perlu Rp${GAME_START_COST.toLocaleString('id-ID')} untuk mulai. Top up untuk bermain!`, 'error');
                balanceDisplay.classList.add('animate-loss');
                setTimeout(() => balanceDisplay.classList.remove('animate-loss'), 500);
                backToProfileBtn.style.display = 'block';
                return;
            }
            if (GAME_START_COST > 0) {
                await updateSaldo(-GAME_START_COST, true);
                showMessage(`Rp.${GAME_START_COST.toLocaleString('id-ID')} dikurangi untuk memulai game.`, 'info');
            }

            gameRunning = true;
            board = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(0));
            totalKemenanganSesi = 0;
            totalKekalahan = 0;
            updateTotalKemenanganSesiDisplay();
            updateTotalKekalahanDisplay();
            updateBalanceDisplay();
            currentBetDisplay.textContent = `Bet: Rp.${currentBet.toLocaleString('id-ID')}`;
            messageArea.textContent = '';
            backToProfileBtn.style.display = 'none'; // Sembunyikan tombol "Buka Menu" saat game berjalan

            showGameControls();
            document.querySelector('.bet-controls').style.display = 'none';
            createNewPiece();
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(gameLoop);
            playBackgroundMusic();
        }
        function gameOver() {
            gameRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            currentPiece = null;

            showMessage('GAME OVER! Saldo habis atau tidak ada tempat.', 'error');
            console.log('Game Over! Saldo Akhir: ' + currentBalance.toLocaleString('id-ID'));
            console.log('Total Kemenangan Sesi Akhir: ' + totalKemenanganSesi.toLocaleString('id-ID'));
            console.log('Total Kekalahan Sesi Akhir: ' + totalKekalahan.toLocaleString('id-ID'));


            if (totalKemenanganSesi > highestKemenangan) {
                saveHighestKemenangan(totalKemenanganSesi);
            }

            hideGameControls();
            document.querySelector('.bet-controls').style.display = 'flex';
            const playAgainBtn = document.createElement('button');
            playAgainBtn.textContent = 'Main Lagi';
            playAgainBtn.id = 'playAgainBtn';
            playAgainBtn.style.cssText = `
                margin-top: 20px;
                width: 100%;
                background-color: var(--game-tertiary-color);
                color: var(--game-text-dark);
                font-size: 1.2em;
                padding: 15px 25px;
                border-radius: 8px;
                cursor: pointer;
                border: none;
                box-shadow: 0 4px 0 #4CAF50;
                transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            `;
            playAgainBtn.onmouseover = () => playAgainBtn.style.backgroundColor = '#8BC34A';
            playAgainBtn.onmouseout = () => playAgainBtn.style.backgroundColor = 'var(--game-tertiary-color)';
            playAgainBtn.onmousedown = () => { playAgainBtn.style.transform = 'translateY(2px)'; playAgainBtn.style.boxShadow = '0 2px 0 #4CAF50'; };
            playAgainBtn.onmouseup = () => { playAgainBtn.style.transform = 'translateY(0)'; playAgainBtn.style.boxShadow = '0 4px 0 #4CAF50'; };
            playAgainBtn.onclick = () => {
                playSound(clickSound);
                playAgainBtn.remove();
                initializeUserAndSaldo();
            };
            document.querySelector('.game-container').insertBefore(playAgainBtn, backToProfileBtn);

            backToProfileBtn.style.display = 'block'; // Tampilkan tombol "Buka Menu" setelah game over
        }

        function hideGameControls() {
            moveLeftBtn.style.display = 'none';
            rotateBtn.style.display = 'none';
            moveRightBtn.style.display = 'none';
        }

        function showGameControls() {
            moveLeftBtn.style.display = 'flex';
            rotateBtn.style.display = 'flex';
            moveRightBtn.style.display = 'flex';
        }

        function adjustBet(amount) {
            const newBet = currentBet + amount;
            if (newBet >= MIN_BET && newBet <= MAX_BET && newBet % BET_INCREMENT === 0) {
                currentBet = newBet;
                currentBetDisplay.textContent = `Bet: Rp${currentBet.toLocaleString('id-ID')}`;
                showMessage(`Bet diatur ke Rp${currentBet.toLocaleString('id-ID')}`, 'info');
            } else {
                showMessage(`Bet harus antara Rp${MIN_BET.toLocaleString('id-ID')} dan Rp${MAX_BET.toLocaleString('id-ID')} dan kelipatan Rp${BET_INCREMENT.toLocaleString('id-ID')}.`, 'error');
            }
        }

        decreaseBetBtn.addEventListener('click', () => {
            playSound(clickSound);
            adjustBet(-BET_INCREMENT);
        });

        increaseBetBtn.addEventListener('click', () => {
            playSound(clickSound);
            adjustBet(BET_INCREMENT);
        });

        document.addEventListener('keydown', e => {
            if (!gameRunning || !currentPiece) return;

            let moved = false;
            let newX = currentX;
            let newY = currentY;
            let newPiece = currentPiece;

            if (e.key === 'ArrowLeft') { newX--; moved = true; playSound(clickSound); }
            else if (e.key === 'ArrowRight') { newX++; moved = true; playSound(clickSound); }
            else if (e.key === 'ArrowDown') { newY++; moved = true; lastDropTime = performance.now(); playSound(clickSound); }
            else if (e.key === 'ArrowUp' || e.key === ' ') {
                const rotated = rotatePiece(currentPiece);
                if (isValidMove(rotated, currentX, currentY)) {
                    newPiece = rotated;
                    moved = true;
                    playSound(clickSound);
                }
            }
            else if (e.key === 'Control' || e.key === 'Enter') {
                while (isValidMove(currentPiece, currentX, currentY + 1)) { currentY++; }
                placePiece();
                return;
            }

            if (moved && isValidMove(newPiece, newX, newY)) {
                currentX = newX;
                currentY = newY;
                currentPiece = newPiece;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY);
        });

        moveLeftBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX - 1, currentY)) { currentX--; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        rotateBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            const newPiece = rotatePiece(currentPiece);
            if (isValidMove(newPiece, currentX, currentY)) { currentPiece = newPiece; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        moveRightBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX + 1, currentY)) { currentX++; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        // =========================================
        // === PROFIL SCRIPT (MODIFIED & INTEGRATED) ===
        // =========================================

        const sidebarMenu = document.getElementById('sidebar-menu');
        const hamburgerIcon = document.getElementById('hamburger-icon');
        const saldoDisplaySidebar = document.getElementById('saldo-display-sidebar');

        // Toggle Sidebar
        hamburgerIcon.addEventListener('click', () => {
            sidebarMenu.classList.toggle('open');
            hamburgerIcon.classList.toggle('open');
            playSound(clickSound);
            // Muat ulang data profil dan riwayat setiap kali sidebar dibuka
            if (sidebarMenu.classList.contains('open')) {
                loadProfileForSidebar();
            }
        });

        // Close sidebar if clicking outside
        document.addEventListener('click', (event) => {
            const isClickInsideSidebar = sidebarMenu.contains(event.target);
            const isClickOnHamburger = hamburgerIcon.contains(event.target);
            if (!isClickInsideSidebar && !isClickOnHamburger && sidebarMenu.classList.contains('open')) {
                sidebarMenu.classList.remove('open');
                hamburgerIcon.classList.remove('open');
            }
        });


        async function loadProfileForSidebar() {
            if (!uid) {
                saldoDisplaySidebar.textContent = 'Saldo: Rp.0 (Harap Login)';
                document.querySelector('#riwayat-deposit-modal tbody').innerHTML = '<tr><td colspan="3" class="empty">Silakan login untuk melihat riwayat.</td></tr>';
                document.querySelector('#riwayat-penarikan-modal tbody').innerHTML = '<tr><td colspan="3" class="empty">Silakan login untuk melihat riwayat.</td></tr>';
                return;
            }

            const { data: userData, error: userError } = await supabase
                .from('users_data')
                .select('saldo')
                .eq('user_id', uid)
                .single();

            if (userError && userError.code !== 'PGRST116') {
                console.error('Error memuat data profil sidebar:', userError.message);
                saldoDisplaySidebar.textContent = `Saldo: Rp.0 (Error)`;
            } else if (userError && userError.code === 'PGRST116') {
                saldoDisplaySidebar.textContent = `Saldo: Rp.0 (Baru)`;
            } else {
                currentBalance = userData.saldo ?? 0; // Pastikan currentBalance global terupdate
                saldoDisplaySidebar.textContent = `Saldo: Rp.${currentBalance.toLocaleString('id-ID')}`;
            }

            // Muat riwayat deposit dan penarikan saat sidebar dibuka
            loadHistory('riwayat-deposit-modal', 'deposit_requests');
            loadHistory('riwayat-penarikan-modal', 'withdraw_requests');
        }

        async function getCurrentUserEmail() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error) {
                console.error('Error fetching user from Supabase auth:', error.message);
                return null;
            }
            if (user && uid !== user.id) {
                uid = user.id;
                localStorage.setItem('uid', user.id);
            }
            return user ? user.email : null;
        }

        // Load deposit/withdrawal history
        async function loadHistory(tableId, tableName) {
            const isDeposit = tableName === 'deposit_requests';
            const tableBody = document.querySelector(`#${tableId} tbody`);
            if (!tableBody) {
                console.error(`Table body with ID ${tableId} not found.`);
                return;
            }
            tableBody.innerHTML = '<tr><td colspan="3" class="empty">Memuat data...</td></tr>';

            if (!uid) {
                tableBody.innerHTML = `<tr><td colspan="3" class="empty">Silakan login untuk melihat riwayat.</td></tr>`;
                return;
            }

            const { data, error } = await supabase
                .from(tableName)
                .select('created_at, amount, status')
                .eq('user_id', uid)
                .order('created_at', { ascending: false });
            if (error) {
                console.error(`Error fetching ${tableName} history:`, error.message);
                tableBody.innerHTML = `<tr><td colspan="3" class="empty">Gagal memuat riwayat ${isDeposit ? 'deposit' : 'penarikan'}.</td></tr>`;
            } else if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="empty">Belum ada riwayat ${isDeposit ? 'deposit' : 'penarikan'}.</td></tr>`;
            } else {
                tableBody.innerHTML = '';
                data.forEach(row => {
                    const date = new Date(row.created_at).toLocaleString('id-ID');
                    const statusClass = `status-${row.status}`;
                    tableBody.innerHTML += `<tr><td>${date}</td><td>Rp.${row.amount.toLocaleString('id-ID')}</td><td class="${statusClass}">${row.status.charAt(0).toUpperCase() + row.status.slice(1)}</td></tr>`;
                });
            }
        }

        // Generic modal handler
        function showModal(modalId, title, message, callback = null) {
            let modalElement;

            if (modalId === 'alert-modal' || modalId === 'success-modal' || modalId === 'error-modal') {
                modalElement = document.getElementById('custom-alert-modal');
                document.getElementById('custom-alert-title').textContent = title;
                document.getElementById('custom-alert-message').textContent = message;
                const okBtn = document.getElementById('custom-alert-ok-btn');
                okBtn.onclick = () => {
                    closeModal('custom-alert-modal');
                    if (callback) callback();
                };
                if (modalId === 'success-modal') {
                    document.getElementById('custom-alert-title').style.color = 'var(--success-neon-color)';
                    document.getElementById('custom-alert-title').style.textShadow = '0 0 10px rgba(57, 255, 20, 0.6)';
                } else if (modalId === 'error-modal') {
                    document.getElementById('custom-alert-title').style.color = 'var(--error-neon-color)';
                    document.getElementById('custom-alert-title').style.textShadow = '0 0 10px rgba(255, 77, 77, 0.6)';
                } else {
                    document.getElementById('custom-alert-title').style.color = 'var(--gold-neon-color)';
                    document.getElementById('custom-alert-title').style.textShadow = '0 0 10px rgba(255, 235, 59, 0.6)';
                }

            } else {
                modalElement = document.getElementById(modalId);
            }

            if (modalElement) {
                modalElement.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.classList.remove('active');
                if (modalId === 'modal-deposit') {
                    document.getElementById('dep-jumlah').value = '';
                    document.getElementById('form-qris').style.display = 'none';
                    document.getElementById('btn-kembali-ewallet').style.display = 'none';
                } else if (modalId === 'modal-withdraw') {
                    document.getElementById('with-jumlah').value = '';
                    // Sembunyikan input bank display saat menutup modal withdraw
                    document.getElementById('with-bank-display').style.display = 'none';
                    document.getElementById('label-bank-display').style.display = 'none';
                }
            }
        }
          // Deposit button logic
        document.getElementById('btn-deposit').onclick = async () => {
            playSound(clickSound);
            if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan deposit.'); return; }
            showModal('modal-deposit');
            const userEmail = await getCurrentUserEmail();
            if (userEmail) {
                document.getElementById('dep-email').value = userEmail;
            }

            const { data, error } = await supabase
                .from('deposit_config')
                .select('*')
                .eq('metode', 'eWallet')
                .single();

            if (error || !data) {
                showModal('error-modal', 'Error', 'Gagal mengambil data eWallet.');
                return;
            }

            document.getElementById('dep-nama').value = data.nama;
            document.getElementById('dep-nomor').value = data.nomor;
            document.getElementById('dep-submit').dataset.metode = 'eWallet';
        };

        document.getElementById('btn-qris').onclick = async () => {
            playSound(clickSound);
            const { data, error } = await supabase
                .from('deposit_config')
                .select('*')
                .eq('metode', 'QRIS')
                .single();

            if (error || !data) {
                showModal('error-modal', 'Error', 'Gagal mengambil data QRIS.');
                return;
            }

            document.getElementById('form-qris').style.display = 'block';
            document.getElementById('gambar-qris').src = data.qris_url;
            document.getElementById('dep-submit').dataset.metode = 'QRIS';
            document.getElementById('btn-kembali-ewallet').style.display = 'inline-block';
        };

        document.getElementById('btn-kembali-ewallet').onclick = async () => {
            playSound(clickSound);
            const { data, error } = await supabase
                .from('deposit_config')
                .select('*')
                .eq('metode', 'eWallet')
                .single();

            if (error || !data) {
                showModal('error-modal', 'Error', 'Gagal mengambil data eWallet.');
                return;
            }

            document.getElementById('form-qris').style.display = 'none';
            document.getElementById('dep-nama').value = data.nama;
            document.getElementById('dep-nomor').value = data.nomor;
            document.getElementById('dep-submit').dataset.metode = 'eWallet';
            document.getElementById('btn-kembali-ewallet').style.display = 'none';
        };

        document.getElementById('dep-submit').onclick = async () => {
            playSound(clickSound);
            if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan deposit.'); return; }
            const nama = document.getElementById('dep-nama').value;
            const email = document.getElementById('dep-email').value;
            const nomor = document.getElementById('dep-nomor').value;
            const jumlah = document.getElementById('dep-jumlah').value;
            const metode = document.getElementById('dep-submit').dataset.metode;

            if (!nama || !nomor || !jumlah || !email) {
                showModal('alert-modal', 'Peringatan', 'Lengkapi semua kolom.');
                return;
            }
            const depositTableBody = document.querySelector('#riwayat-deposit-modal tbody');
            const now = new Date();
            const dateString = now.toLocaleString('id-ID');
            const tempId = `temp-${Date.now()}`;
            const newRowHTML = `<tr class="pending-item" data-id="${tempId}"><td>${dateString}</td><td>Rp${parseInt(jumlah).toLocaleString('id-ID')}</td><td class="status-pending">Pending</td></tr>`;

            if (depositTableBody.querySelector('.empty')) {
                depositTableBody.innerHTML = '';
            }
            depositTableBody.insertAdjacentHTML('afterbegin', newRowHTML);

            const { error } = await supabase.from('deposit_requests').insert([
                { user_id: uid, nama, metode, amount: parseInt(jumlah), status: 'pending', email: email }
            ]);

            if (error) {
                console.error(error);
                showModal('error-modal', 'Gagal!', 'Gagal kirim deposit. Silakan coba lagi.');
                const tempRow = depositTableBody.querySelector(`[data-id="${tempId}"]`);
                if (tempRow) {
                    tempRow.remove();
                }
            } else {
                showModal('success-modal', 'Berhasil!', 'Permintaan deposit dikirim.');
                closeModal('modal-deposit');
                loadProfileForSidebar(); // Refresh saldo di sidebar
                loadHistory('riwayat-deposit-modal', 'deposit_requests'); // Refresh riwayat
            }
        };

        // Copy button functionality
        document.querySelectorAll('.btn-copy').forEach(button => {
            button.addEventListener('click', (event) => {
                playSound(clickSound);
                const targetId = event.currentTarget.dataset.target;
                const inputElement = document.getElementById(targetId);
                if (inputElement) {
                    inputElement.select();
                    inputElement.setSelectionRange(0, 99999);
                    try {
                        navigator.clipboard.writeText(inputElement.value)
                            .then(() => {
                                showModal('success-modal', 'Berhasil Disalin!', 'Nomor berhasil disalin: ' + inputElement.value);
                            })
                            .catch(err => {
                                console.error('Gagal menyalin teks: ', err);
                                showModal('error-modal', 'Gagal!', 'Gagal menyalin nomor. Silakan salin manual.');
                            });
                    } catch (err) {
                        document.execCommand('copy');
                        showModal('success-modal', 'Berhasil Disalin!', 'Nomor berhasil disalin: ' + inputElement.value);
                    }
                }
            });
        });

        // Hapus event listener with-metode karena kita tidak lagi menggunakan select
        // document.getElementById('with-metode').addEventListener('change', function() {
        //     const selectedMethod = this.value;
        //     const bankInput = document.getElementById('with-bank');
        //     const bankLabel = document.getElementById('label-bank');
        //     if (selectedMethod === 'Bank') {
        //         bankInput.style.display = 'block';
        //         bankLabel.style.display = 'block';
        //         bankInput.setAttribute('required', 'true');
        //     } else {
        //         bankInput.style.display = 'none';
        //         bankLabel.style.display = 'none';
        //         bankInput.removeAttribute('required');
        //         bankInput.value = '';
        //     }
        // });

        // Withdraw button logic (MODIFIED)
        document.getElementById('btn-withdraw').onclick = async () => {
            playSound(clickSound);
            if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan penarikan.'); return; }
            
            // Ambil data user dari tabel users_data
            const { data: userData, error: userError } = await supabase
                .from('users_data')
                .select('username, email, bank_account_data') // *** PERUBAHAN DI SINI: bank_account_info menjadi bank_account_data ***
                .eq('user_id', uid)
                .single();

            if (userError) {
                console.error('Error fetching user data for withdraw form:', userError.message);
                showModal('error-modal', 'Gagal Memuat Data', 'Gagal memuat data profil Anda untuk penarikan. Pastikan data bank/e-wallet Anda sudah tersimpan.');
                closeModal('modal-withdraw');
                return;
            }

            if (userData) {
                document.getElementById('with-username').value = userData.username || '';
                document.getElementById('with-email').value = userData.email || '';

                // *** PERUBAHAN DI SINI: Akses properti bank_account_data ***
                if (userData.bank_account_data) {
                    const bankData = userData.bank_account_data; // Gunakan nama variabel yang lebih sesuai
                    
                    document.getElementById('with-metode-display').value = bankData.bank_name || '';
                    document.getElementById('with-metode-hidden').value = bankData.bank_name || ''; // Simpan di hidden input

                    document.getElementById('with-nomor-akun-display').value = bankData.account_number || '';
                    document.getElementById('with-nomor-akun-hidden').value = bankData.account_number || ''; // Simpan di hidden input

                    // Logika untuk menampilkan input "Nama Bank" jika metode adalah "Bank"
                    if (bankData.bank_name && bankData.bank_name.toLowerCase() === 'bank') {
                        document.getElementById('with-bank-display').value = bankData.actual_bank_name || ''; // Asumsikan ada properti actual_bank_name
                        document.getElementById('with-bank-hidden').value = bankData.actual_bank_name || '';
                        document.getElementById('with-bank-display').style.display = 'block';
                        document.getElementById('label-bank-display').style.display = 'block';
                    } else {
                        document.getElementById('with-bank-display').style.display = 'none';
                        document.getElementById('label-bank-display').style.display = 'none';
                        document.getElementById('with-bank-display').value = ''; // Pastikan dikosongkan
                        document.getElementById('with-bank-hidden').value = ''; // Pastikan dikosongkan
                    }

                    // Tampilkan modal setelah semua data terisi
                    showModal('modal-withdraw');

                } else {
                    showModal('alert-modal', 'Data Rekening Belum Ada', 'Mohon lengkapi informasi rekening/e-wallet Anda di profil sebelum melakukan penarikan. Silahkan hubungi Admin jika Anda belum mengisi.');
                    closeModal('modal-withdraw');
                    return;
                }
            } else {
                showModal('error-modal', 'Data User Tidak Ditemukan', 'Data user tidak ditemukan. Mohon coba login ulang.');
                closeModal('modal-withdraw');
                return;
            }

            document.getElementById('with-jumlah').setAttribute('max', currentBalance);
        };

        document.getElementById('with-submit').onclick = async () => {
            playSound(clickSound);
            if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan penarikan.'); return; }

            // Ambil nilai dari input display atau hidden yang sudah diisi otomatis
            const nama = document.getElementById('with-username').value.trim(); // Menggunakan username sebagai nama penerima
            const email = document.getElementById('with-email').value.trim();
            const metode = document.getElementById('with-metode-hidden').value; // Ambil dari hidden input
            const nomor = document.getElementById('with-nomor-akun-hidden').value.trim(); // Ambil dari hidden input
            const bank = document.getElementById('with-bank-hidden').value.trim(); // Ambil dari hidden input, jika ada
            const jumlahInput = document.getElementById('with-jumlah').value;
            const submitButton = document.getElementById('with-submit');

            if (!nama || !metode || !nomor || !jumlahInput || !email) {
                showModal('alert-modal', 'Peringatan', 'Terjadi kesalahan internal. Data profil tidak lengkap. Silakan coba lagi atau hubungi support.');
                return;
            }

            const jumlah = parseInt(jumlahInput);
            if (isNaN(jumlah) || jumlah <= 0) {
                showModal('alert-modal', 'Peringatan', 'Jumlah penarikan harus angka positif yang valid.');
                return;
            }

            if (jumlah > currentBalance) {
                showModal('alert-modal', 'Saldo Tidak Cukup', `Saldo Anda saat ini Rp.${currentBalance.toLocaleString('id-ID')}. Jumlah penarikan melebihi saldo.`);
                return;
            }

            const MIN_WITHDRAWAL_AMOUNT = 10000;
            if (jumlah < MIN_WITHDRAWAL_AMOUNT) {
                showModal('alert-modal', 'Penarikan Minimum', `Jumlah penarikan minimal adalah Rp.${MIN_WITH_WITHDRAWAL_AMOUNT.toLocaleString('id-ID')}.`);
                return;
            }

            const bankAccountInfo = {
                bank_name: metode, // Metode yang sudah diambil dari Supabase (DANA, OVO, GoPay, Bank)
                account_number: nomor,
                account_holder: nama, // Username sebagai nama holder
                email: email
            };

            // Tambahkan nama bank aktual jika metodenya adalah 'Bank'
            if (metode.toLowerCase() === 'bank' && bank) {
                bankAccountInfo.actual_bank_name = bank;
            }

            const withdrawTableBody = document.querySelector('#riwayat-penarikan-modal tbody');
            const now = new Date();
            const dateString = now.toLocaleString('id-ID');
            const tempId = `temp-${Date.now()}`;
            const newRowHTML = `<tr class="pending-item" data-id="${tempId}"><td>${dateString}</td><td>Rp.${jumlah.toLocaleString('id-ID')}</td><td class="status-pending">Pending</td></tr>`;

            if (withdrawTableBody.querySelector('.empty')) {
                withdrawTableBody.innerHTML = '';
            }
            withdrawTableBody.insertAdjacentHTML('afterbegin', newRowHTML);

            submitButton.classList.add('loading');
            submitButton.disabled = true;

            try {
                const session = await supabase.auth.getSession();
                if (!session.data.session) {
                    showModal('alert-modal', 'Sesi Tidak Valid', 'Sesi pengguna tidak valid. Silakan login kembali.');
                    const tempRow = withdrawTableBody.querySelector(`[data-id="${tempId}"]`);
                    if (tempRow) { tempRow.remove(); }
                    throw new Error('No active session.');
                }
                const accessToken = session.data.session.access_token;

                // Memanggil Edge Function untuk memproses penarikan
                const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/processed_withdrawal`;

                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        amount: jumlah,
                        bank_account_info: bankAccountInfo // Kirim semua info bank_account_info
                    })
                });

                if (!response.ok) {
                    const errorResponseText = await response.text();
                    console.error("HTTP Error response from Edge Function (status " + response.status + "):", errorResponseText);
                    let errorMessage = 'Terjadi kesalahan tidak dikenal saat memproses penarikan.';
                    try {
                        const errorData = JSON.parse(errorResponseText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        console.warn("Failed to parse error response as JSON. Using raw text.");
                        errorMessage = `Server Error: ${errorResponseText.substring(0, 150)}...`;
                    }
                    showModal('error-modal', 'Gagal!', errorMessage);
                    const tempRow = withdrawTableBody.querySelector(`[data-id="${tempId}"]`);
                    if (tempRow) { tempRow.remove(); }
                    return;
                }

                const data = await response.json();

                if (data.message) {
                    showModal('success-modal', 'Berhasil!', data.message);
                    closeModal('modal-withdraw');
                    if (data.new_saldo !== undefined) {
                        currentBalance = data.new_saldo;
                        balanceDisplay.textContent = `Rp.${currentBalance.toLocaleString('id-ID')}`;
                        saldoDisplaySidebar.textContent = `Saldo: Rp.${currentBalance.toLocaleString('id-ID')}`; // Update sidebar saldo
                    } else {
                        await loadProfileForSidebar(); // Fallback untuk refresh saldo
                    }
                    await loadHistory('riwayat-penarikan-modal', 'withdraw_requests');
                } else {
                    showModal('error-modal', 'Gagal!', 'Permintaan berhasil dikirim, tetapi tidak ada konfirmasi yang jelas.');
                    const tempRow = withdrawTableBody.querySelector(`[data-id="${tempId}"]`);
                    if (tempRow) { tempRow.remove(); }
                }

            } catch (error) {
                console.error('Error saat memanggil API penarikan:', error);
                showModal('error-modal', 'Error Jaringan', 'Gagal terhubung ke server. Silakan coba lagi. Detail: ' + error.message);
                const tempRow = withdrawTableBody.querySelector(`[data-id="${tempId}"]`);
                if (tempRow) { tempRow.remove(); }
            } finally {
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
            }
        };

        // History button logic
        document.getElementById('btn-history').onclick = async () => {
            playSound(clickSound);
            if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melihat riwayat transaksi.'); return; }
            showModal('modal-history');
            await loadHistory('riwayat-deposit-modal', 'deposit_requests');
            await loadHistory('riwayat-penarikan-modal', 'withdraw_requests');
        };

        // Logout Button Logic
        document.getElementById('logout-btn').addEventListener('click', async () => {
            playSound(clickSound);
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error logging out:', error.message);
                showModal('error-modal', 'Logout Gagal', 'Terjadi kesalahan saat logout. Silakan coba lagi.');
            } else {
                localStorage.removeItem('uid'); // Clear UID from local storage
                showModal('success-modal', 'Logout Berhasil', 'Anda telah berhasil logout.', () => {
                    window.location.href = 'index.html'; // Redirect to login page
                });
            }
        });

        // Initialize user, saldo, and game on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeUserAndSaldo();
            hideGameControls();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBoard();
        });

        document.body.addEventListener('click', () => {
            playBackgroundMusic();
        }, { once: true });

        // Update "Buka Menu" button text
        backToProfileBtn.textContent = 'Buka Menu';
        backToProfileBtn.addEventListener('click', () => {
            playSound(clickSound);
            sidebarMenu.classList.add('open');
            hamburgerIcon.classList.add('open');
            loadProfileForSidebar(); // Muat data profil saat menu dibuka dari tombol ini
        });

    </script>
</body>
</html>